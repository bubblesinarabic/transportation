<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>وسائل النقل – النص الحي</title>

  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg-light:#F6FBFB;
      --bg-teal:#A2D9DA;
      --ink:#112537;
      --muted:#5B6B77;

      --teal:#42B8BB;
      --teal-soft:#D7F2F2;
      --pink:#E08499;
      --pink-soft:#FBE3EA;

      --card:#FFFFFF;
      --border:#E5E7EB;
      --shadow:0 8px 24px rgba(0,0,0,.1);
    }

    body{
      font-family:'Almarai',sans-serif;
      background: linear-gradient(135deg,var(--bg-light),var(--bg-teal));
      margin:0; padding:0;
      direction:rtl;
      color:var(--ink);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter:blur(10px);
      background:rgba(246,251,251,.85);
      border-bottom:1px solid rgba(0,0,0,.08);
    }
    .topbar-inner{
      max-width:1200px; margin:auto;
      padding:12px 16px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .brand{ direction:ltr; display:flex; align-items:center; gap:10px; }
    .brand img{ width:72px; height:auto; display:block; }
    @media (max-width: 780px){ .brand img{ width:56px; } }

    .top-title{ text-align:right; line-height:1.2; }
    .top-title h1{ margin:0; font-size:20px; color:var(--ink); }
    .top-title .sub{ font-size:12px; color:var(--muted); margin-top:4px; }

    .app-container{max-width:1200px;margin:24px auto;padding:0 16px;}
    .layout{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:18px 20px;}
    .info-card{flex:1;min-width:280px;}
    .text-card{flex:1.7;min-width:360px;position:relative;background:var(--card);}

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
      align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.noun{ background:var(--teal); }
    .dot.verb{ background:var(--pink); }

    #textContainer{
      max-height:620px;
      overflow-y:scroll;
      overflow-x:hidden;
      padding-right:6px;
      padding-left:0;
      scrollbar-gutter: stable;
    }

    .line{
      background: rgba(255,255,255,0.92);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      margin-bottom:10px;
      font-size:22px;
      line-height:2.2;
    }

    .w{
      display:inline-block;
      padding:2px 6px;
      border-radius:12px;
      margin:0 1px;
      transition:180ms ease;
      cursor:pointer;
      background:transparent;
      position:relative;
    }

    .w.live{ border:1px solid rgba(17,37,55,0.08); }
    .w.live.noun{
      color:var(--teal);
      background:linear-gradient(180deg, rgba(66,184,187,0.08), rgba(66,184,187,0.02));
    }
    .w.live.verb{
      color:var(--pink);
      background:linear-gradient(180deg, rgba(224,132,153,0.10), rgba(224,132,153,0.03));
    }

    .w.selected{
      transform: scale(1.18);
      outline:3px solid rgba(17,24,39,0.12);
      box-shadow:0 12px 20px rgba(0,0,0,0.12);
      z-index:5;
    }
    .w.selected.noun{ background:var(--teal-soft); }
    .w.selected.verb{ background:var(--pink-soft); }

    .info-title{font-size:18px;font-weight:900;margin-bottom:10px;color:#2F4858;}
    .muted{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.5;}

    /* ✅ Scene card hidden until mapped word selected */
    .scene-box{
      display:none;
      margin-top:12px;
      padding:10px;
      border-radius:14px;
      background:#F9FAFB;
      border:1px solid var(--border);
    }
    .scene-box.on{ display:block; }

    .scene-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin-bottom:8px;
    }
    #sceneVideo{
      width:100%;
      max-height:240px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--border);
      object-fit:contain;
    }
  </style>
</head>

<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img
        src="https://raw.githubusercontent.com/bubblesinarabic/transportation/main/BubblesinArabic.png"
        alt="Bubbles in Arabic Logo">
    </div>

    <div class="top-title">
      <h1>وسائل النقل – النص الحي</h1>
      <div class="sub"></div>
    </div>
  </div>
</header>

<div class="app-container">
  <div class="layout">

    <div class="card text-card">
      <div class="toolbar">
        <div class="legend">
          <span class="pill"><span class="dot noun"></span> أسماء / مفردات</span>
          <span class="pill"><span class="dot verb"></span> أفعال</span>
        </div>
      </div>
      <div id="textContainer"></div>
    </div>

    <div class="card info-card">
      <div class="info-title">معلومات الكلمة</div>
      <div id="infoContent" class="muted">اضغطي على كلمة ملوّنة من النص.</div>

      <div id="sceneBox" class="scene-box">
        <div class="scene-title">
          <i data-lucide="film"></i>
          مشهد مرتبط بالفعل/الكلمة
        </div>

        <video id="sceneVideo" playsinline muted controls preload="metadata"></video>
        <div id="sceneHint" class="muted"></div>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons();

  function removeTashkeel(t){ return (t||"").replace(/[\u064B-\u0652\u0670\u0640]/g,""); }
  function stripPunctuation(t){ return (t||"").replace(/[.,!?؟،；؛:"«»…()\[\]]/g,""); }
  function normalizeArabic(t){
    return removeTashkeel(t||"")
      .replace(/[أإآ]/g,"ا")
      .replace(/ؤ/g,"و")
      .replace(/ئ/g,"ي")
      .replace(/ء/g,"")
      .replace(/ة/g,"ه")
      .replace(/ى/g,"ي");
  }
  function normKey(rawWord){
    const cleaned = stripPunctuation(rawWord||"");
    return normalizeArabic(cleaned).trim();
  }

  const LINES = [
    "السيارة وسيلة نقل سريعة تساعدنا على الذهاب إلى المدرسة أو التنزه مع العائلة.",
    "الطائرة تطير في السماء، وتساعدنا في السفر إلى أماكن بعيدة بسرعة.",
    "الدراجة لها عجلتان، ونستخدمها في اللعب أو التنقل لمسافات قصيرة.",
    "الدراجة النارية تسير بسرعة ولها محرك قوي مثل السيارة.",
    "الباخرة نوع من السفن، وهي أكبر وتستخدم للسفر عبر المحيطات.",
    "الحافلة تأخذ الكثير من الناس في رحلة، مثل الذهاب إلى المدرسة أو العمل.",
    "القطار يسير على السكك الحديدية، وينقل الناس والبضائع بين المدن بسرعة وراحة.",
    "المركب يبحر في الماء ويُستخدم لنقل الناس والبضائع عبر الأنهار والبحيرات."
  ];

  // ✅ your mapping (normalized + corrected)
  const VERB_SCENES = {
    "يسير": "scene_5.mp4",
    "تطير": "scene_6.mp4",
    "تسير": "scene_3.mp4",
    "ينقل": "scene_8.mp4",
    "السفر": "scene_7.mp4",
    "ونستخدمها": "scene_2.mp4",
    "الذهاب": "scene_1.mp4",
    "تاخذ": "scene_4.mp4"
  };

  // ✅ alias map (so "تأخذ" becomes "تاخذ")
  const ALIASES = { "تأخذ":"تاخذ", "تاخذ":"تاخذ" };
  const resolveKey = (k)=> ALIASES[k] || k;

  // ✅ Scene player: same-origin first (GitHub Pages), then jsDelivr fallback
  const SCENE_BASES = [
    new URL("./", window.location.href).href, // GitHub Pages same folder
    "https://cdn.jsdelivr.net/gh/bubblesinarabic/transportation@main/" // fallback
  ];
  const sceneCandidates = (file) => SCENE_BASES.map(b => b + file);

  const sceneBox   = document.getElementById("sceneBox");
  const sceneVideo = document.getElementById("sceneVideo");
  const sceneHint  = document.getElementById("sceneHint");

  function hideScene(){
    sceneVideo.pause();
    sceneVideo.removeAttribute("src");
    sceneVideo.load();
    sceneBox.classList.remove("on");
    sceneHint.textContent = "";
  }

  function showAndPlayScene(file, label){
    sceneBox.classList.add("on");
    sceneHint.textContent = `⏳ جاري تحميل مشهد: ${label} …`;

    const urls = sceneCandidates(file);
    let i = 0;

    const tryNext = () => {
      if(i >= urls.length){
        sceneHint.textContent =
          "⚠️ لم يتم تحميل الفيديو. جرّبي فتح scene_1.mp4 مباشرة من رابط Pages. إذا كان الملف LFS لن يعمل داخل Pages.";
        return;
      }

      const url = urls[i++];
      sceneVideo.pause();
      sceneVideo.src = url;
      sceneVideo.load();

      // status signals
      sceneVideo.onwaiting = () => { sceneHint.textContent = "⏳ جاري التحميل…"; };
      sceneVideo.oncanplay = () => { sceneHint.textContent = "✅ جاهز للتشغيل."; };
      sceneVideo.onstalled = () => { sceneHint.textContent = "⏳ الاتصال بطيء…"; };

      sceneVideo.onerror = () => tryNext();

      // click-triggered play is allowed
      const p = sceneVideo.play();
      if(p && typeof p.catch === "function"){
        p.catch(() => {
          sceneHint.textContent = "✅ تم التحميل. اضغطي تشغيل داخل الفيديو إذا لم يبدأ تلقائياً.";
        });
      }
    };

    tryNext();
  }

  // Render words (kept minimal)
  const textContainer = document.getElementById("textContainer");
  let allWordSpans = [];

  function splitWords(line){ return line.split(" ").filter(Boolean); }

  function renderLines(lines){
    textContainer.innerHTML = "";
    allWordSpans = [];

    lines.forEach((line) => {
      const lineDiv = document.createElement("div");
      lineDiv.className = "line";

      const tokens = splitWords(line);
      tokens.forEach((t, idx) => {
        const s = document.createElement("span");
        s.className = "w live noun"; // keep your styling; you can reapply your full live logic
        s.textContent = removeTashkeel(t);
        s.dataset.key = resolveKey(normKey(t));
        lineDiv.appendChild(s);
        if(idx < tokens.length - 1) lineDiv.appendChild(document.createTextNode(" "));
        allWordSpans.push(s);
      });

      textContainer.appendChild(lineDiv);
    });
  }

  function clearSelected(){ allWordSpans.forEach(s => s.classList.remove("selected")); }

  textContainer.addEventListener("click", (e) => {
    const w = e.target.closest(".w");
    if(!w) return;

    clearSelected();
    w.classList.add("selected");

    const key = w.dataset.key;
    const sceneFile = VERB_SCENES[key];

    if(sceneFile){
      showAndPlayScene(sceneFile, key);
    }else{
      hideScene();
    }
  });

  renderLines(LINES);
  hideScene();
});
</script>
</body>
</html>
